var DataStore={_db:null,init:function(b,c){this.Plugins=Plugins;var a=new Date();this._db=openDatabase("crossrider_data_"+b,1,"Crossrider Data Store",20*1024*1024);this.Plugins.init(this._db,b,function(){this._db.transaction(function(d){d.executeSql("create table if not exists extension_code(data_type varchar(255) primary key, value longtext, app_id integer, version varchar(10), updated_at datetime default (datetime('now','localtime')))",[],function(){c();},function(){Crossrider.Utils.internalDebug("extension_code table create error",arguments);});});}.bind(this));},getData:function(a,b){this._db.transaction(function(c){c.executeSql("select data_type,value,version from extension_code where app_id = ?",[a],function(d,f){var g={};for(var e=0;e<f.rows.length;e++){var h=f.rows.item(e);g[h.data_type]={value:h.value,version:h.version};}b(g,false);}.bind(this),function(){Crossrider.Utils.internalDebug("data load error",arguments);});}.bind(this));},saveApp:function(c,d,b,a){this._db.transaction(function(e){e.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, 'app',?,?,datetime('now'))",[c,d,b],function(){if(typeof(a)==="function"){a();}},function(){Crossrider.Utils.internalDebug("app save error",arguments);});});},saveBGApp:function(c,d,b,a){this._db.transaction(function(e){e.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, 'bg_script',?,?,datetime('now'))",[c,d,b],function(){if(typeof(a)==="function"){a();}},function(){Crossrider.Utils.internalDebug("bg script save error",arguments);});});},saveManifest:function(c,b,a){this._db.transaction(function(d){d.executeSql("replace into extension_code (app_id, data_type, value, updated_at) values(?, 'manifest',?,datetime('now'))",[c,b],function(){if(typeof(a)==="function"){a();}},function(){Crossrider.Utils.internalDebug("manifest save error",arguments);});});},clearData:function(a){this._db.transaction(function(b){b.executeSql("drop table extension_code",[],function(){},function(){Crossrider.Utils.internalDebug("extension data clear error",arguments);});});}};var PluginTypes={BACKGROUND:0,APP_CODE:1,POPUP:5};function IsValidPluginType(b){var c=false;for(var a in PluginTypes){if(PluginTypes[a]===b){c=true;break;}}return c;}var Plugins={_db:null,_appID:-1,init:function(a,b,c){this._appID=b;this._db=a;this._db.transaction(function(d){d.executeSql("create table if not exists plugins(id integer primary key, name varchar(255), code longtext, version integer)",[],function(){c();},function(){Crossrider.Utils.internalDebug("plugins table create error",arguments);});});},getData:function(a){this.getPlugins(function(b){var c={plugins_list_info:b,plugins_order:[],plugins_version:0};this._db.transaction(function(d){var e=[];for(var f in PluginTypes){if(PluginTypes.hasOwnProperty(f)){e.push("plugins_"+PluginTypes[f]);}}d.executeSql("select data_type,value,version from extension_code where data_type in ('"+e.join("','")+"') and app_id = ?",[this._appID],function(g,j){var i="";for(var k=0,h=j.rows.length;k<h;++k){i=j.rows.item(k).data_type.replace("plugins_","");i=parseInt(i);c.plugins_order[i]=j.rows.item(k).value;}if(j.rows.length>0){c.plugins_version=parseInt(j.rows.item(0).version);}a(c);}.bind(this),function(){Crossrider.Utils.internalDebug("Plugins.getData error",arguments);});}.bind(this));}.bind(this));},getPlugins:function(a){this._db.transaction(function(b){b.executeSql("select * from plugins",[],function(d,f){var c={};for(var e=0;e<f.rows.length;e++){var g=f.rows.item(e);c[g.id]={name:g.name,version:g.version,code:g.code};}a(c);}.bind(this),function(){Crossrider.Utils.internalDebug("getPlugins error",arguments);});}.bind(this));},getPluginsCodeByType:function(d,b,i){var a=(typeof(b)==="object"&&b.hasOwnProperty("plugins_order")&&b.hasOwnProperty("plugins_list_info"));if(typeof(d)==="number"&&IsValidPluginType(d)&&a){var f=function(m,l){if(!i){return l.code;}var j="plugin"+m+"_exception";var k=[];k.push("//Plugin "+l.name+"\n");k.push("try { \n\n");k.push(l.code);k.push("\n\n}catch("+j+"){ \n");k.push("console.log('Error in Plugin:"+l.name+" (Id:"+m+", version: "+l.version+")\\n' + "+j+".message);");k.push("} \n\n");return k.join("");};if(b.plugins_order[d]&&typeof b.plugins_order[d]==="string"){var e=b.plugins_order[d].split(","),g={};plugins_code="",plugin_id=-1;for(var c=0,h=e.length;c<h;++c){plugin_id=parseInt(e[c]);if(!b.plugins_list_info.hasOwnProperty(plugin_id)){return"";}if(d===PluginTypes.APP_CODE){}plugins_code+=f(plugin_id,b.plugins_list_info[plugin_id])+"\n\n";}return plugins_code;}}return"";},removeAllPlugins:function(a){this._db.transaction(function(b){b.executeSql("delete from plugins",[],function(c,d){c.executeSql("delete from extension_code where data_type LIKE 'plugins_%' and app_id = ?",[this._appID],function(e){a();}.bind(this),function(){Crossrider.Utils.internalDebug("deleting plugins_list error",arguments);}.bind(this));}.bind(this),function(){Crossrider.Utils.internalDebug("deleting plugins table error",arguments);});}.bind(this));},savePluginsTypeList:function(f,d,b,h){var a=[];for(var c=0,e=b.length;c<e;++c){if(b[c].hasOwnProperty("id")){a.push(b[c].id);}}var g=a.reverse().join(",").toString();this._db.transaction(function(i){i.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, ?, ?,?,datetime('now'))",[this._appID,("plugins_"+f),g,d],function(j){h();}.bind(this),function(){Crossrider.Utils.internalDebug("failed to save plugins list",arguments);}.bind(this));}.bind(this));},savePlugins:function(g,c,f){var h=0,i=this,a=false,b={};for(var d=0,e=g.length;d<e&&!a;++d){i._db.transaction((function(j,k){return function(l){b=k[j];l.executeSql("replace into plugins(id, name, code, version) values(?, ?, ?, ?)",[b.id,b.name,b.code,b.version],function(){++h;if(c&&(h==k.length)){c();}}.bind(this),function(){Crossrider.Utils.internalDebug("failed to save plugin "+b.name,arguments);f();a=true;}.bind(this));}.bind(i);})(d,g));}}};
