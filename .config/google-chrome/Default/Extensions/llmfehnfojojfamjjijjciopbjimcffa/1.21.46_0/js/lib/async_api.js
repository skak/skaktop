var AsyncAPI={_dom:{},_responseQueue:[],_responseQueueBusy:false,init:function(a){this._api=a;window.addEventListener("message",this._handlePageFunction.bind(this),false);this._dom.body=document.getElementsByTagName("body")[0];return this;},_handlePageFunction:function(i){var j=i.origin,g=i.data;if((this._api.manifest.domain!==undefined&&j.indexOf(this._api.manifest.domain)<0)||g.caller!=="asyncAPI"||g.appID!==this._api.appID){return;}var d=g.action.split("."),h,a;if(d.length===1){h=this._api[d[0]];a=this._api;}else{if(d.length===2){h=this._api[d[0]][d[1]];a=this._api[d[0]];}}if(typeof(h)==="function"){if(d[0]=="fbAPI"||(g.action==="push.subscribe")){var k=function(){var e=[g.action];for(var f=0;f<arguments.length;f++){e.push(arguments[f]);}this.sendResponse(e,g.iframe,g.ts);}.bind(this);g.params.push(k);if(g.action==="push.subscribe"){g.params.push(true);}h.apply(a,g.params);}else{if(g.action==="cookie.get"||g.action==="db.setFromRemote"||g.action==="request.get"||g.action==="request.post"){var l=function(e){var f=[g.action,true,e];this.sendResponse(f,g.iframe,g.ts);}.bind(this);g.params.push(l);var b=function(e){var f=[g.action,false,e];this.sendResponse(f,g.iframe,g.ts);}.bind(this);g.params.push(b);h.apply(a,g.params);}else{if(g.action==="push.unsubscribe"){g.params.push(true);}var c=h.apply(a,g.params);this.sendResponse([g.action,c],g.iframe,g.ts);}}}},sendResponse:function(b,c,e){if(b!=="QUEUE"){this._responseQueue.push({args:b,iframe:c,ts:e});if(this._responseQueueBusy){return;}}if(this._responseQueue.length>0){this._responseQueueBusy=true;var d=this._responseQueue.shift();var f=d.args[0].replace(/\./g,"_");var a=this._createResponseElement(f,d.ts);a.value=JSON.stringify({args:d.args});if(d.iframe===true){this._api.dom.callPageFunction("callCrossriderAsyncApi"+this._api.appID,f,d.ts);}else{this._api.dom.callPageFunction("crossrider.AsyncAPI.onPageResponse",f,d.ts);}setTimeout(this.sendResponse.bind(this),10,"QUEUE");}else{this._responseQueueBusy=false;}},setTargetIframe:function(b){var a=document.createElement("script");a.type="text/javascript";a.innerHTML="function callCrossriderAsyncApi"+this._api.appID+'(action,ts){var el = document.getElementById("crossrider-response-element-'+this._api.appID+'"+action+ts); var response = JSON.parse(el.value); el.parentNode.removeChild(el); document.getElementById("'+b+'").contentWindow.postMessage({caller:"asyncAPIResponse", appID:'+this._api.appID+', args:response.args, ts:ts},"*");}';this._dom.body.appendChild(a);},_createResponseElement:function(c,b){var a=document.createElement("textarea");a.id="crossrider-response-element-"+this._api.appID+c+b;a.style.display="none";this._dom.body.appendChild(a);return a;}};
