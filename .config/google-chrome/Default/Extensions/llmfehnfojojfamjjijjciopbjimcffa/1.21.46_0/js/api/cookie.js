TableNames={USER_COOKIES:"cookies",DB_ASYNC:"DBAsync",INTERNAL_DB:"internaldb",INTERNAL_DB_ASYNC:"internalDBAsync",TableNames_LENGTH:4};var GetTableNamesArray=function(d){try{var b=[];var c;for(var a in TableNames){c=a.toLowerCase();if(c.indexOf("length")<0){if((d===undefined)||((typeof d==="boolean")&&((d&&c.indexOf("async")>0)||(!d&&c.indexOf("async")<0)))){b.push(TableNames[a]);}}}return b;}catch(f){Reports.error(new ErrorMessage(f,"GetTableNamesArray"));}};var GetSyncDBTableNamesArray=function(){var a=false;return GetTableNamesArray(a);};var GetAsyncDBTableNamesArray=function(){var a=true;return GetTableNamesArray(a);};IsValidTableName=function(b){try{var a=false;if(b&&(typeof b==="string")){var d=GetTableNamesArray();for(var c=0;c<d.length;++c){currentTableName=d[c];if(currentTableName===b){a=true;break;}}}}catch(f){Reports.error(new ErrorMessage(f,"IsValidTableName"));}return a;};var Cookie=function(b){var a=b;this.cookie=function(d,e,c){if(e!==undefined){a.db.set(d,e,c);}else{return a.db.get(d);}};this.cookie.list=function(){return a.db.list();};this.cookie.remove=function(c){a.db.remove(c);};this.cookie.removeAll=function(){a.db.removeAll();};this.cookie.get=function(e,d,c,g,f){a.db.setFromRemote(e,d,c,g,f);};a.mysite={cookie:function(f,g,d){if(a.manifest.domain!==undefined&&a.manifest.domain!==null){var e=new Date().getTime();if(g!==undefined){if(d===undefined||d>e){if(d===undefined){d=new Date(2030,1,1,0,0,0,0).getTime();}else{d=d.getTime();}if(typeof(Crossrider)!=="undefined"){Crossrider.setRealCookie(f,g,d);}else{a.updateRealCookie(f,{value:g,expires:d});InternalMessaging.messageToBackground({action:"setRealCookie",params:[f,g,d,a.tabID]});}}else{if(typeof(Crossrider)!=="undefined"){Crossrider.unsetRealCookie(f);}else{a.unsetRealCookie(f);InternalMessaging.messageToBackground({action:"unsetRealCookie",params:[f]});}}}else{var i=a._cookies[TableNames.USER_COOKIES].mysite[f],h=i?i.expires:null;if(h!==null&&typeof(h)!=="number"){h=new Date(h).getTime();}if(i&&(h===null||h>e)){return i.value;}else{return null;}}}}};return this.cookie;};function _surroundCallbackWithTryCatch(c,b){var a=c;if(IsDefined(UserReport)&&IsDefined(c)){b=b||"DB UserCallback";if(c.hasOwnProperty("name")&&IsDefined(c.name)){b=c.name;}a=UserReport.surroundCallbackWithTryCatch(c,b);}return a;}function DBManager(m){var k=IsValidTableName(m)?m:TableNames.USER_COOKIES;var i=null;var j=["InstallerParams","InstallationThankYouPage","InstallationTime"];var o=["cookies"];var n=function(p){i=p;var r=i._cookies[k];for(var q in r){if(r.hasOwnProperty(q)){if(q==="mysite"){continue;}var s=r[q];if(typeof(s.expires)!=="number"){s.expires=new Date(s.expires).getTime();}}}};var b=function(r){try{if(typeof(r)!=="string"&&typeof(r)!=="number"){return null;}if(r==="mysite"){var q=new Error("mysite is a reserved name");UserReport.error(new ErrorMessage(q,"appAPI.db.get"));return null;}var p=new Date().getTime();var s=i._cookies[k][r];if(s&&s.expires>p){return s.value;}else{if(s){d(r);}return null;}}catch(t){Reports.error(new ErrorMessage(t,"DBManager->get"));}};var e=function(p){try{if(typeof(p)!=="string"&&typeof(p)!=="number"){return null;}if(b(p)!==null){return new Date(i._cookies[k][p].expires);}}catch(q){Reports.error(new ErrorMessage(q,"DBManager->getExpiration"));}return null;};var d=function(p){try{if(typeof p=="string"){if(typeof(Crossrider)!=="undefined"){Crossrider.unsetCookie(p,k);}else{InternalMessaging.messageToBackground({action:"unsetCookie",params:[p,k],passCallback:true},function(){i.unsetCookie(p,k);});}}}catch(q){Reports.error(new ErrorMessage(q,"DBManager->remove"));}};var l=function(s,t,p,v){try{if(typeof(s)!=="string"&&typeof(s)!=="number"){return false;}if(s==="mysite"){var r=new Error("mysite is a reserved name");UserReport.error(new ErrorMessage(r,"appAPI.db.set"));return false;}var q=new Date().getTime();if(p===undefined||p>q){p=(p===undefined)?new Date(2030,1,1,0,0,0,0).getTime():p.getTime();i.updateCookie(s,{value:t,expires:p},k);v=_surroundCallbackWithTryCatch(v,"appAPI.db.set UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.setCookie(s,t,p,k,undefined,v);}else{InternalMessaging.messageToBackground({action:"setCookie",params:[s,t,p,k,i.tabID],passCallback:true},function(){if(v&&typeof v==="function"){v();}});}}else{d(s);}}catch(u){Reports.error(new ErrorMessage(u,"DBManager->set"));}return true;};var h=function(){var q={};var t=i._cookies[k];try{for(var r in t){if(t.hasOwnProperty(r)&&r!=="mysite"){if(o.indexOf(k)<0||(o.indexOf(k)>=0&&j.indexOf(r)<0)){var p=b(r);if(p!==null){q[r]=p;}}}}}catch(s){Reports.error(new ErrorMessage(s,"DBManager->list"));}return q;};var g=function(){var r=[],q=i._cookies[k],s=null;try{for(var p in q){if(q.hasOwnProperty(p)&&p!=="mysite"){if(o.indexOf(k)<0||(o.indexOf(k)>=0&&j.indexOf(p)<0)){s=b(p);if(s!==null){r.push({key:p,value:s,expiration:new Date(q[p].expires).getTime()});}}}}}catch(t){Reports.error(new ErrorMessage(t,"DBManager->getList"));}return r;};var f=function(){try{var p=o.indexOf(k)>=0;if(typeof(Crossrider)!=="undefined"){Crossrider.removeAllCookies(k,p,j);}else{InternalMessaging.messageToBackground({action:"removeAllCookies",params:[k,p,j]});}}catch(q){Reports.error(new ErrorMessage(q,"DBManager->removeAll"));}};var a=function(){try{if(typeof(Crossrider)!=="undefined"){Crossrider.removeExpiredCookies(k);}else{InternalMessaging.messageToBackground({action:"removeExpiredCookies",params:[k]});}}catch(p){Reports.error(new ErrorMessage(p,"DBManager->removeExpired"));}};var c=function(q,p){try{var s=new Date(p);if(s.toString()!=="Invalid Date"){p=s;}if(typeof q=="string"&&(p instanceof Date||typeof p=="undefined")){if(typeof(Crossrider)!=="undefined"){Crossrider.updateCookieExpiration(q,p,k);}else{InternalMessaging.messageToBackground({action:"updateCookieExpiration",params:[q,p.getTime(),k]});}}}catch(r){Reports.error(new ErrorMessage(r,"DBManager->updateExpiration"));}};return{init:n,get:b,getExpiration:e,set:l,list:h,getList:g,remove:d,removeAll:f,removeExpired:a,updateExpiration:c};}function AsyncDBManager(f){var n=IsValidTableName(f)?f:TableNames.DB_ASYNC;var g=null;var j=this;var l=function(u){if(u&&u.hasOwnProperty("value")){return u.value;}return null;};var h=function(v){var w={};if(v){for(var u in v){w[u]=v[u].value;}}return w;};var c=function(w){var x=[];var u;if(w){for(var v in w){u=w[v];if(u.hasOwnProperty("value")&&u.hasOwnProperty("expires")){x.push({key:v,value:u.value,expiration:new Date(u.expires).getTime()});}}}return x;};var r=function(w,v){var u=function(){};if(w&&typeof w==="function"){if(v&&typeof v==="function"){u=function(x){w(v(x));}.bind(j);}else{u=function(x){w(x);}.bind(j);}}return u;};var o=function(u,v){if((typeof(u)==="string"||typeof(u)==="number")&&(v&&typeof v==="function")){if(typeof(Crossrider)!=="undefined"){Crossrider.getCookieAsync(n,u,r(v));}else{InternalMessaging.messageToBackground({action:"getCookieAsync",params:[n,u],passCallback:true},r(v));}}};var p=function(u){g=u;};var s=function(u,w){try{if((typeof(u)==="string"||typeof(u)==="number")&&(w&&typeof w==="function")){w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.get UserCallback");o(u,r(w,l));}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->get"));}};var d=function(u,w){try{if(w&&typeof w==="function"&&typeof u=="string"){w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.getExpiration UserCallback");o(u,function(y){var x=(y!==null&&y.hasOwnProperty("expires"))?y.expires:null;w(new Date(x));});}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->getExpiration"));}};var m=function(w,x,u,z){try{if((typeof(w)==="string"||typeof(w)==="number")){var v=new Date().getTime();z=_surroundCallbackWithTryCatch(z,"appAPI.db.async.set UserCallback");if(u===undefined||u>v){u=(u===undefined)?new Date(2030,1,1,0,0,0,0).getTime():u.getTime();if(typeof(Crossrider)!=="undefined"){Crossrider.setCookieAsync(w,x,u,n,z);}else{InternalMessaging.messageToBackground({action:"setCookieAsync",params:[w,x,u,n],passCallback:true},r(z));}}else{if(IsDefined(z)&&typeof z=="function"){z(false);}}}}catch(y){Reports.error(new ErrorMessage(y,"AsyncDBManager->set"));}};var q=function(v){try{if(v&&typeof v==="function"){v=_surroundCallbackWithTryCatch(v,"appAPI.db.async.list UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.getAllCookiesAsync(n,r(v,h));}else{InternalMessaging.messageToBackground({action:"getAllCookiesAsync",params:[n],passCallback:true},r(v,h));}}}catch(u){Reports.error(new ErrorMessage(u,"AsyncDBManager->list"));}};var k=function(v){try{if(v&&typeof v==="function"){v=_surroundCallbackWithTryCatch(v,"appAPI.db.async.getList UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.getAllCookiesAsync(n,r(v,c));}else{InternalMessaging.messageToBackground({action:"getAllCookiesAsync",params:[n],passCallback:true},r(v,c));}}}catch(u){Reports.error(new ErrorMessage(u,"AsyncDBManager->getList"));}};var t=function(u,w){try{w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.remove UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.unsetCookieAsync(u,n,w);}else{InternalMessaging.messageToBackground({action:"unsetCookieAsync",params:[u,n],passCallback:true},r(w));}}catch(v){Reports.error(new ErrorMessage(v,"AsyncDBManager->remove"));}};var e=function(v){try{v=_surroundCallbackWithTryCatch(v,"appAPI.db.async.removeAll UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.removeAllCookiesAsync(n,v);}else{InternalMessaging.messageToBackground({action:"removeAllCookiesAsync",params:[n],passCallback:true},r(v));}}catch(u){Reports.error(new ErrorMessage(u,"AsyncDBManager->removeAll"));}};var a=function(v){try{v=_surroundCallbackWithTryCatch(v,"appAPI.db.async.removeExpired UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.removeExpiredCookiesAsync(n,v);}else{InternalMessaging.messageToBackground({action:"removeExpiredCookiesAsync",params:[n],passCallback:true},r(v));}}catch(u){Reports.error(new ErrorMessage(u,"AsyncDBManager->removeExpired"));}};var i=function(v,u,y){try{var x=new Date(u);if(x.toString()!=="Invalid Date"){u=x;}y=_surroundCallbackWithTryCatch(y,"appAPI.db.async.updateExpiration UserCallback");if(typeof(Crossrider)!=="undefined"){Crossrider.updateCookieExpirationAsync(v,u,n,y);}else{InternalMessaging.messageToBackground({action:"updateCookieExpirationAsync",params:[v,u.getTime(),n],passCallback:true},r(y));}}catch(w){Reports.error(new ErrorMessage(w,"AsyncDBManager->updateExpiration"));}};var b=function(v,x,u,z,w){try{z=_surroundCallbackWithTryCatch(z,"appAPI.db.async.setFromRemote onSuccess UserCallback");w=_surroundCallbackWithTryCatch(w,"appAPI.db.async.setFromRemote onFailure UserCallback");g.request.get(v,function(A){A=A.replace(/[\r\t\n]+/gi,"").replace(/>\s+</gi,"><").replace(/\s{2}/gi," ");m(x,A,u,function(B){if(B){if(z&&typeof z==="function"){z(A);}}else{w(B);}});}.bind(this),function(A){if(w&&typeof w==="function"){w(A);}});}catch(y){Reports.error(new ErrorMessage(y,"AsyncDBManager->setFromRemote"));}};return{init:p,get:s,getExpiration:d,set:m,list:q,getList:k,remove:t,removeAll:e,removeExpired:a,updateExpiration:i,setFromRemote:b};}
